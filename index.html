<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sonora UC3M – Emisión en directo</title>

<style>
:root{
  --rojo:#be1622;
  --negro:#050307;
  --text:#fff;
}

/* === GLOBAL === */
body{
  margin:0;
  font-family: Helvetica, Arial, sans-serif;
  background:radial-gradient(circle at top,#be1622 0%,#3a0307 55%,#000 100%);
  color:#fff;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  overflow:hidden;
}

/* CONTENEDOR */
.wrap{
  width:90%;
  max-width:950px;
}

/* LOGO */
.logo{
  width:380px;
  max-width:70vw;
  margin:auto;
  margin-bottom:16px;
}

/* SUBTÍTULO */
.subtitulo{
  font-size:1.15rem;
  margin-bottom:35px;
  opacity:.9;
  font-weight:300;
}

/* TARJETA DIRECTO */
.card{
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.18);
  padding:28px 32px;
  border-radius:22px;
  backdrop-filter:blur(18px);
  margin-top:10px;
}

/* TEXTO */
.label{
  font-size:.75rem;
  letter-spacing:4.5px;
  font-weight:700;
  margin-bottom:8px;
  opacity:.9;
  text-transform:uppercase;
}
.item{
  font-size:1.9rem;
  font-weight:700;
  margin-bottom:20px;
}
.sub{
  font-size:1.25rem;
  opacity:.88;
}
.empty{opacity:.65;}

/* === QR === */
.qr-box{
  position:fixed;
  right:26px; bottom:26px;
  width:125px; height:125px;
  background:rgba(0,0,0,.55);
  border-radius:20px; padding:8px;
  box-shadow:0 12px 28px rgba(0,0,0,.6);
}
.qr-box img{
  width:100%; height:100%;
  border-radius:12px; display:block;
}

/* MÓVIL */
@media(max-width:820px){
  .logo{width:260px;}
  .subtitulo{font-size:1rem;margin-bottom:22px;}
  .item{font-size:1.45rem;}
  .sub{font-size:1.05rem;}
  .qr-box{width:95px;height:95px;right:15px;bottom:15px;}
}
</style>

</head>
<body>

<div class="wrap">

  <!-- LOGO -->
  <img src="sonora_2.1_blanco.png" class="logo" alt="Sonora UC3M">

  <!-- SUBTÍTULO -->
  <div class="subtitulo">Emisión en directo – Sonora UC3M</div>

  <!-- DIRECTO -->
  <div class="card" id="liveBox">
    <div class="label">Ahora</div>
    <div id="now" class="item empty">Cargando...</div>

    <div class="label" style="margin-top:15px;">Siguiente</div>
    <div id="next" class="sub empty">Cargando...</div>
  </div>

</div>

<!-- QR → Programación -->
<div class="qr-box">
  <a href="https://sonorauc3m.github.io/programacion/" target="_blank" rel="noopener">
    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&color=FFFFFF&bgcolor=190306&data=https%3A%2F%2Fsonorauc3m.github.io%2Fprogramacion%2F"
      alt="QR programación Sonora UC3M">
  </a>
</div>

<script>
  // === CONFIG HOJA GOOGLE ===
  const SHEET_ID = "1g9f3Ue9GtdaTbpxp3DCXncrNPhjnHPk0m9QTXdfSAxM";
  const SHEET_NAME = "Directo";

  const nowEl  = document.getElementById("now");
  const nextEl = document.getElementById("next");

  function gvizUrl(sheetName) {
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  }

  async function fetchSheet() {
    try {
      const res  = await fetch(gvizUrl(SHEET_NAME));
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2)); // recorta wrapper gviz
      const rows = json.table.rows || [];
      return rows.map(r => (r.c || []).map(c => c && c.v ? String(c.v) : ""));
    } catch (e) {
      console.error("Error cargando hoja:", e);
      return [];
    }
  }

  function parseTimeRange(raw) {
    if (!raw) return null;
    const matches = raw.match(/(\d{1,2}):(\d{2})/g);
    if (!matches || matches.length === 0) return null;

    const [startStr, endStr] = matches;
    const [sh, sm] = startStr.split(":").map(Number);
    let eh, em;

    if (endStr) {
      [eh, em] = endStr.split(":").map(Number);
    } else {
      const total = sh * 60 + sm + 60;
      eh = Math.floor(total / 60);
      em = total % 60;
    }

    return {
      startMinutes: sh * 60 + sm,
      endMinutes: eh * 60 + em,
      label: raw
    };
  }

  async function updateLive() {
    const rows = (await fetchSheet()).slice(1); // quitamos cabecera
    if (!rows.length) {
      nowEl.textContent  = "No hay emisión en directo";
      nextEl.textContent = "Sin más programas";
      nowEl.classList.add("empty");
      nextEl.classList.add("empty");
      return;
    }

    // Convertimos filas en slots
    const slots = [];
    rows.forEach(cols => {
      const [diaRaw, horaRaw, programa] = cols;
      if (!diaRaw || !horaRaw || !programa) return;
      const t = parseTimeRange(horaRaw.trim());
      if (!t) return;
      slots.push({
        dia: diaRaw.trim(),
        prog: programa.trim(),
        startMinutes: t.startMinutes,
        endMinutes: t.endMinutes,
        label: t.label
      });
    });

    if (!slots.length) {
      nowEl.textContent  = "No hay emisión en directo";
      nextEl.textContent = "Sin más programas";
      nowEl.classList.add("empty");
      nextEl.classList.add("empty");
      return;
    }

    const nowDate    = new Date();
    const nowMinutes = nowDate.getHours() * 60 + nowDate.getMinutes();
    const weekday    = nowDate.getDay();
    const dayNames   = ["domingo","lunes","martes","miércoles","jueves","viernes","sábado"];
    const todayName  = dayNames[weekday];

    const todaysSlots = slots.filter(s =>
      s.dia.trim().toLowerCase().includes(todayName)
    );

    const list = todaysSlots.length ? todaysSlots : slots;

    let current = null;
    let next    = null;

    for (const s of list) {
      if (nowMinutes >= s.startMinutes && nowMinutes < s.endMinutes) {
        current = s;
      } else if (nowMinutes < s.startMinutes) {
        if (!next || s.startMinutes < next.startMinutes) {
          next = s;
        }
      }
    }

    // AHORA
    if (current) {
      nowEl.textContent = current.prog;
      nowEl.classList.remove("empty");
    } else {
      nowEl.textContent = "No hay emisión en directo";
      nowEl.classList.add("empty");
    }

    // SIGUIENTE
    if (next) {
      nextEl.textContent = `${next.label} · ${next.prog}`;
      nextEl.classList.remove("empty");
    } else {
      nextEl.textContent = "Sin más programas";
      nextEl.classList.add("empty");
    }
  }

  updateLive();
  setInterval(updateLive, 20000);
</script>

</body>
</html>

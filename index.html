<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sonora UC3M – Emisión</title>

<style>
:root{
  --rojo:#be1622;
  --negro:#050307;
  --text:#fff;
  --soft:#bfbfbf;
}

/* === GLOBAL === */
body{
  margin:0;
  font-family: Helvetica, Arial, sans-serif;
  background:radial-gradient(circle at top,#be1622 0%,#3a0307 55%,#000 100%);
  color:#fff;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  overflow:hidden;
}

/* CONTENEDOR CENTRAL */
.wrap{
  width:90%;
  max-width:900px;
}

/* TITULARES */
h1{
  font-size:3.2rem;
  margin-bottom:4px;
  font-weight:800;
  letter-spacing:3px;
}
h2{
  font-size:1.1rem;
  color:#d9d9d9;
  margin-bottom:22px;
  font-weight:300;
}

/* TARJETA DIRECTO */
.card{
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.18);
  padding:28px 32px;
  border-radius:22px;
  backdrop-filter:blur(18px);
  transition:.25s;
}

/* BLOQUES */
.label{
  font-size:.75rem;
  letter-spacing:4.5px;
  font-weight:700;
  opacity:.95;
  margin-bottom:8px;
  text-transform:uppercase;
}
.item{
  font-size:1.9rem;
  font-weight:700;
  margin-bottom:20px;
}
.sub{
  font-size:1.25rem;
  opacity:.85;
}

/* SI NO ESTÁ EN DIRECTO */
.empty{
  opacity:.7;
  font-size:1.1rem;
  margin-bottom:25px;
}

/* === QR === */
.qr-box{
  position:fixed;
  right:28px;
  bottom:28px;
  width:125px;
  height:125px;
  z-index:999;
  background:rgba(0,0,0,0.55);
  border-radius:20px;
  padding:8px;
  box-shadow:0 12px 28px rgba(0,0,0,0.7);
}
.qr-box img{
  width:100%;
  height:100%;
  display:block;
  border-radius:12px;
}

/* === MOBILE === */
@media(max-width:800px){
  h1{font-size:2.3rem;}
  .item{font-size:1.65rem;}
  .sub{font-size:1.05rem;}
  .card{padding:22px;}
  .qr-box{
    width:95px;
    height:95px;
    right:16px;
    bottom:16px;
  }
}
</style>
</head>
<body>

<div class="wrap">

  <h1>SONORA UC3M</h1>
  <h2>Emisión en directo</h2>

  <div class="card" id="liveBox">
    <div class="label">Ahora</div>
    <div id="now" class="item empty">Cargando...</div>

    <div class="label" style="margin-top:15px;">Siguiente</div>
    <div id="next" class="sub empty">Cargando...</div>
  </div>

</div>

<!-- QR >>> página oficial programación -->
<div class="qr-box">
  <a href="https://sonorauc3m.github.io/programacion/" target="_blank" rel="noopener">
    <!-- QR blanco sobre rojo oscuro, sin marco gordo blanco -->
    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&color=FFFFFF&bgcolor=190306&data=https%3A%2F%2Fsonorauc3m.github.io%2Fprogramacion%2F"
      alt="QR Sonora – Programación"
    />
  </a>
</div>

<script>
/* Google Sheet */
const SHEET_ID="1g9f3Ue9GtdaTbpxp3DCXncrNPhjnHPk0m9QTXdfSAxM";
const SHEET="Directo";

async function fetchSheet(){
  try{
    const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET)}`;
    const raw=await fetch(url).then(r=>r.text());
    const json=JSON.parse(raw.substr(47).slice(0,-2));
    return json.table.rows.map(r=>(r.c||[]).map(c=>c?.v||""));
  }catch(e){
    console.error(e);
    return [];
  }
}

function parseRange(text){
  if(!text) return null;
  const m=text.match(/\d{1,2}:\d{2}/g);
  if(!m) return null;
  const[startStr,endStr]=m;
  const[sh,sm]=startStr.split(":").map(Number);
  let eh,em;
  if(endStr){
    [eh,em]=endStr.split(":").map(Number);
  }else{
    const total=sh*60+sm+60;
    eh=Math.floor(total/60);
    em=total%60;
  }
  return{
    ini:sh*60+sm,
    fin:eh*60+em,
    label:text
  };
}

async function update(){
  const rows=await fetchSheet();
  if(!rows.length){
    document.getElementById("now").textContent="No hay datos de programación";
    document.getElementById("next").textContent="–";
    return;
  }

  rows.shift(); // encabezados
  const slots=rows
    .map(([dia,hora,prog])=>{
      const t=parseRange(hora||"");
      if(!dia||!prog||!t) return null;
      return{
        dia:dia.trim(),
        prog:prog.trim(),
        ...t
      };
    })
    .filter(Boolean);

  const nowDate=new Date();
  const minutes=nowDate.getHours()*60+nowDate.getMinutes();

  // prioriza hoy, pero permite otros días para el "siguiente"
  const weekday=nowDate.getDay(); // 0 dom, 1 lun...
  const todayName=
    weekday===2 ? "martes" :
    weekday===4 ? "jueves" : null;

  const todaySlots=todayName
    ? slots.filter(s=>s.dia.toLowerCase().includes(todayName))
    : [];

  let nowSlot=null;
  let nextSlot=null;

  const consider= todaySlots.length ? todaySlots : slots;

  for(const s of consider){
    if(minutes>=s.ini && minutes<s.fin){
      nowSlot=s;
    }else if(minutes<s.ini){
      if(!nextSlot || s.ini<nextSlot.ini){
        nextSlot=s;
      }
    }
  }

  const nowEl=document.getElementById("now");
  const nextEl=document.getElementById("next");
  const box=document.getElementById("liveBox");

  if(nowSlot){
    nowEl.classList.remove("empty");
    nowEl.textContent=nowSlot.prog;
    box.style.borderColor="#ffffff";
  }else{
    nowEl.classList.add("empty");
    nowEl.textContent="No hay emisión en directo";
    box.style.borderColor="rgba(255,255,255,.18)";
  }

  if(nextSlot){
    nextEl.classList.remove("empty");
    nextEl.textContent=`${nextSlot.label} · ${nextSlot.prog}`;
  }else{
    nextEl.classList.add("empty");
    nextEl.textContent="Sin más programas";
  }
}

// primera carga + refresco cada 20s
update();
setInterval(update,20000);
</script>

</body>
</html>
